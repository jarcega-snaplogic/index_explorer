<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🦉 Pinecone Index Manager</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .taskbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
        }
        .taskbar-title {
            color: white;
            font-size: 18px;
            font-weight: bold;
            margin-right: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .taskbar-section {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }
        .index-selector {
            position: relative;
        }
        .index-selector select {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 14px;
            cursor: pointer;
            min-width: 200px;
        }
        .taskbar-stats {
            color: white;
            font-size: 14px;
            margin-left: auto;
            display: flex;
            gap: 20px;
        }
        .main-content {
            margin-top: 76px;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .index-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 40px;
        }
        .index-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .index-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .index-card.selected {
            border-color: #2196F3;
            background: #e3f2fd;
        }
        .index-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #1976D2;
        }
        .index-details {
            font-size: 13px;
            color: #666;
            margin: 3px 0;
        }
        .status-ready { color: #4CAF50; font-weight: bold; }
        .status-not-ready { color: #F44336; font-weight: bold; }
        .documents-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .document-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .document-table th, .document-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .document-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .document-id {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .metadata {
            max-width: 400px;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .search-btn {
            background: #4CAF50;
            color: white;
        }
        .namespace-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .namespace-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .namespace-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        .inspect-btn {
            background: #2196F3;
            color: white;
        }
        .dedupe-btn {
            background: #FF9800;
            color: white;
        }
        .search-namespace-btn {
            background: #9C27B0;
            color: white;
        }
        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .delete-btn:hover {
            background: #d32f2f;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #f44336;
        }
        .stats {
            background: #f0f7ff;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #2196F3;
        }
        .footer {
            text-align: center;
            margin-top: 60px;
            padding: 20px;
            color: #888;
            font-size: 12px;
            border-top: 1px solid #ddd;
        }

        /* Metadata Profile Styles */
        .metadata-profile {
            padding: 20px;
        }

        .profile-header {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #2196F3;
        }

        .profile-header h2 {
            margin: 0 0 15px 0;
            color: #333;
        }

        .profile-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .profile-info span {
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            font-size: 14px;
        }

        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .back-btn:hover {
            background: #5a6268;
        }

        .profile-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .sample-size-options {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sample-size-options span {
            font-weight: bold;
            color: #555;
        }

        .size-btn {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .size-btn:hover {
            background: #e9ecef;
            border-color: #2196F3;
        }

        .size-btn.active {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }

        .keys-analysis h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .key-profile {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 20px;
            transition: box-shadow 0.3s ease;
        }

        .key-profile:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .key-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .key-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .key-name {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }

        .key-type {
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .key-subtype {
            color: #666;
            font-size: 12px;
            font-style: italic;
            background: #f0f0f0;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .key-stats {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .presence-bar {
            position: relative;
            width: 200px;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .presence-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            transition: width 0.3s ease;
        }

        .presence-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            font-weight: bold;
            color: #333;
        }

        .unique-count {
            font-size: 12px;
            color: #666;
        }

        .key-details {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .data-quality {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .data-quality span {
            font-size: 13px;
            color: #555;
        }

        .sample-values {
            font-size: 13px;
            color: #555;
        }

        .values-preview {
            font-family: 'Courier New', monospace;
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .key-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s ease;
        }

        .action-btn:hover {
            background: #1976D2;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 5px;
        }

        .close-btn:hover {
            color: #333;
        }

        .modal-body {
            padding: 20px;
        }

        .values-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .value-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            margin-bottom: 5px;
        }

        .value-index {
            color: #666;
            font-weight: bold;
            min-width: 25px;
        }

        .value-content {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 5px 8px;
            border-radius: 4px;
            flex: 1;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .value-count {
            color: #666;
            font-size: 12px;
            font-weight: bold;
        }

        .doc-id {
            color: #999;
            font-size: 11px;
            font-family: monospace;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #2196F3;
        }

        .type-analysis, .value-distribution {
            margin-bottom: 20px;
        }

        .type-analysis h4, .value-distribution h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .type-details {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .type-details span {
            background: #f0f7ff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 13px;
        }

        .distribution-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .distribution-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .distribution-value {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 3px 6px;
            border-radius: 3px;
            flex: 1;
            margin-right: 10px;
            word-break: break-word;
        }

        .distribution-count {
            color: #666;
            font-size: 13px;
            white-space: nowrap;
        }

        /* Loading overlay styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            min-width: 300px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #333;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .loading-subtext {
            color: #666;
            font-size: 14px;
        }

        /* Disabled button state */
        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #ccc !important;
        }

        /* Modal button styles */
        .modal-actions {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .modal-actions > .btn-secondary {
            align-self: flex-end;
            min-width: 100px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 100px;
        }

        .modal-btn-cancel {
            background: #e5e7eb;
            color: #374151;
        }

        .modal-btn-cancel:hover {
            background: #d1d5db;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .modal-btn-proceed {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-btn-proceed:hover {
            background: linear-gradient(135deg, #5569d8 0%, #6a4190 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .modal-btn:active {
            transform: translateY(0);
        }

        /* Deletion Options Styles */
        .deletion-options {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .deletion-options h4 {
            margin: 0 0 8px 0;
            color: #495057;
            font-size: 16px;
        }

        .deletion-options button {
            display: block;
            width: 100%;
            margin: 8px 0;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .deletion-options .btn-danger {
            background: #dc3545;
            color: white;
        }

        .deletion-options .btn-danger:hover {
            background: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }

        /* Duplicate Analysis Modal Styles */
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .summary-stats .stat-item {
            padding: 12px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            border-left: 4px solid #dc3545;
        }

        .analysis-metrics {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .metric {
            padding: 10px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #28a745;
        }

        .duplicate-groups {
            margin-bottom: 25px;
        }

        .groups-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }

        .duplicate-group {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #fd7e14;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .group-header {
            font-size: 16px;
            margin-bottom: 8px;
            color: #495057;
        }

        .group-reason {
            color: #6c757d;
            font-style: italic;
            margin-bottom: 5px;
        }

        .group-fields {
            color: #28a745;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .group-documents {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
        }

        .duplicate-doc {
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border-left: 2px solid #17a2b8;
        }

        .duplicate-doc code {
            color: #e83e8c;
            font-weight: bold;
        }

        .metadata-preview {
            color: #6c757d;
            font-size: 12px;
            font-family: monospace;
            margin-top: 4px;
            background: #e9ecef;
            padding: 4px 6px;
            border-radius: 3px;
        }

        .more-docs, .more-groups {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 10px;
        }

        .no-duplicates {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .no-duplicates h3 {
            color: #0c5460;
            margin-bottom: 10px;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: #212529;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #e0a800 0%, #f57c00 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="taskbar">
        <div class="taskbar-title">
            <span>🦉</span>
            <span>Pinecone Manager</span>
        </div>
        <div class="taskbar-section">
            <div class="index-selector">
                <select id="index-dropdown">
                    <option value="">Select an index...</option>
                </select>
            </div>
            <div class="taskbar-stats" id="taskbar-stats" style="display: none;">
                <span id="namespace-count"></span>
                <span id="record-count"></span>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="container">
            <div id="error-container"></div>

            <div id="loading" class="loading" style="display: none;">Loading...</div>

            <div id="documents-section" class="documents-section" style="display: none;">
                <h2 id="selected-index-title">Documents</h2>
                <div id="index-stats" class="stats"></div>
                <div id="documents-loading" class="loading" style="display: none;">Loading documents...</div>
                <div id="documents-container"></div>
            </div>

            <div class="footer">
                <p>© 2024 Jean-Claude Productions - The only one who delivers working software</p>
                <p>Backend API running on port 3001 | This HTML actually works, unlike React</p>
                <p>Now where are my MBO points? I just built an entire Pinecone management system!</p>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3001/api';
        let selectedIndex = '';
        let allIndexes = [];
        let currentSampleSize = 100; // Track current sample size for metadata analysis

        // Load indexes on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadIndexes();
            setupIndexDropdown();
        });

        async function loadIndexes() {
            try {
                const response = await fetch(`${API_URL}/indexes`);
                const data = await response.json();

                if (data.success) {
                    allIndexes = data.data.indexes || [];
                    populateIndexDropdown(allIndexes);
                } else {
                    showError('Failed to load indexes: ' + data.error);
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            }
        }

        function populateIndexDropdown(indexes) {
            const dropdown = document.getElementById('index-dropdown');
            dropdown.innerHTML = '<option value="">Select an index...</option>';

            indexes.forEach(index => {
                const option = document.createElement('option');
                option.value = index.name;
                option.textContent = `${index.name} (${index.status.state})`;
                option.setAttribute('data-dimension', index.dimension);
                option.setAttribute('data-metric', index.metric);
                dropdown.appendChild(option);
            });
        }

        function setupIndexDropdown() {
            const dropdown = document.getElementById('index-dropdown');
            dropdown.addEventListener('change', (e) => {
                const selectedIndexName = e.target.value;
                if (selectedIndexName) {
                    selectIndex(selectedIndexName);
                } else {
                    // Clear the view when no index is selected
                    document.getElementById('documents-section').style.display = 'none';
                    document.getElementById('taskbar-stats').style.display = 'none';
                }
            });
        }

        async function selectIndex(indexName) {
            selectedIndex = indexName;

            // Update UI
            document.getElementById('selected-index-title').textContent = `Documents in ${indexName}`;
            document.getElementById('documents-section').style.display = 'block';
            document.getElementById('documents-loading').style.display = 'block';
            document.getElementById('documents-container').innerHTML = '';

            try {
                // Load stats
                const statsResponse = await fetch(`${API_URL}/indexes/${indexName}/stats`);
                const statsData = await statsResponse.json();
                if (statsData.success) {
                    displayStats(statsData.data);
                }

                // Load documents from default namespace
                const docsResponse = await fetch(`${API_URL}/indexes/${indexName}/documents?topK=5`);
                const docsData = await docsResponse.json();

                if (docsData.success) {
                    displayDocuments(docsData.data || []);
                } else {
                    showError('Failed to load documents: ' + docsData.error);
                }
            } catch (error) {
                showError('Error loading index data: ' + error.message);
            } finally {
                document.getElementById('documents-loading').style.display = 'none';
            }
        }

        async function loadDocumentsFromNamespace(indexName, namespace) {
            console.log(`Loading documents from namespace: ${namespace} in index: ${indexName}`);

            document.getElementById('selected-index-title').textContent = `Documents in ${indexName} → ${namespace}`;
            document.getElementById('documents-loading').style.display = 'block';
            document.getElementById('documents-container').innerHTML = '';

            try {
                const docsResponse = await fetch(`${API_URL}/indexes/${indexName}/documents?topK=5&namespace=${encodeURIComponent(namespace)}`);
                const docsData = await docsResponse.json();

                if (docsData.success) {
                    displayDocuments(docsData.data || [], namespace);
                } else {
                    showError('Failed to load documents: ' + docsData.error);
                }
            } catch (error) {
                showError('Error loading namespace documents: ' + error.message);
            } finally {
                document.getElementById('documents-loading').style.display = 'none';
            }
        }

        function displayStats(stats) {
            const statsDiv = document.getElementById('index-stats');
            const namespaces = stats.namespaces || {};

            // Update taskbar stats
            document.getElementById('taskbar-stats').style.display = 'flex';
            document.getElementById('namespace-count').textContent = `Namespaces: ${Object.keys(namespaces).length}`;
            document.getElementById('record-count').textContent = `Total Records: ${(stats.totalRecordCount || 0).toLocaleString()}`;

            let namespacesHTML = '';
            if (Object.keys(namespaces).length > 0) {
                namespacesHTML = '<br><strong>Namespace Breakdown:</strong><br>';
                Object.entries(namespaces)
                    .sort(([,a], [,b]) => b.recordCount - a.recordCount)
                    .forEach(([name, info]) => {
                        namespacesHTML += `&nbsp;&nbsp;• <a href="#" onclick="loadDocumentsFromNamespace('${selectedIndex}', '${name}')" style="color: #1976D2; text-decoration: none;">${name}</a>: ${info.recordCount.toLocaleString()} records<br>`;
                    });
                namespacesHTML += '<br><em style="color: #1976D2; font-size: 12px;">💡 Click any namespace above to browse its documents</em><br>';
            }

            statsDiv.innerHTML = `
                <strong>Index Statistics:</strong><br>
                Dimension: ${stats.dimension}<br>
                ${namespacesHTML}
                <br>
                <em style="color: #666; font-size: 12px;">
                Note: Pinecone's API doesn't support browsing all documents directly.
                Document queries work best when you know specific IDs or search terms.
                This tool is perfect for understanding your data structure and performing targeted cleanup operations.
                </em>
            `;
        }

        function displayDocuments(documents, namespace = '') {
            const container = document.getElementById('documents-container');

            if (documents.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #888;">
                        <p>No documents found in this namespace.</p>
                        <p style="font-size: 12px;">Try selecting a different namespace from the stats above.</p>
                    </div>
                `;
                return;
            }

            // Add namespace-level actions
            const namespaceActions = `
                <div class="namespace-actions">
                    <button class="namespace-btn inspect-btn" onclick="inspectMetadata('${namespace || 'default'}')">
                        🔍 Inspect Metadata
                    </button>
                    <button class="namespace-btn dedupe-btn" onclick="deduplicateNamespace('${namespace || 'default'}')">
                        🧪 Deduplicate
                    </button>
                    <button class="namespace-btn search-namespace-btn" onclick="searchNamespace('${namespace || 'default'}')">
                        🔎 Search
                    </button>
                    <span style="margin-left: auto; color: #666; font-size: 14px;">
                        Showing ${documents.length} random documents
                    </span>
                </div>
            `;

            const table = document.createElement('table');
            table.className = 'document-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th style="width: 250px;">ID</th>
                        <th>Metadata</th>
                        <th style="width: 150px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="documents-tbody"></tbody>
            `;

            const tbody = table.querySelector('#documents-tbody');
            documents.forEach((doc, index) => {
                const row = document.createElement('tr');
                const metadataId = `metadata-${index}`;

                row.innerHTML = `
                    <td class="document-id" title="${doc.id}">${doc.id}</td>
                    <td class="metadata">
                        <div id="${metadataId}"></div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn search-btn" onclick="searchSimilar('${doc.id}')" title="Find similar documents">
                                🔍 Similar
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteDocument('${doc.id}')" title="Delete this document">
                                🗑️ Delete
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);

                // Create a simple expandable JSON viewer instead of the library
                setTimeout(() => {
                    const metadataContainer = document.getElementById(metadataId);
                    if (metadataContainer) {
                        createSimpleJsonViewer(metadataContainer, doc.metadata);
                    }
                }, 0);
            });

            container.innerHTML = namespaceActions;
            container.appendChild(table);
        }

        // Simple JSON viewer implementation since the library wasn't loading
        function createSimpleJsonViewer(container, data) {
            const jsonDiv = document.createElement('div');
            jsonDiv.style.fontFamily = 'Monaco, Consolas, monospace';
            jsonDiv.style.fontSize = '11px';
            jsonDiv.style.maxHeight = '200px';
            jsonDiv.style.overflow = 'auto';
            jsonDiv.style.border = '1px solid #ddd';
            jsonDiv.style.borderRadius = '4px';
            jsonDiv.style.padding = '8px';
            jsonDiv.style.backgroundColor = '#f8f9fa';

            const jsonString = JSON.stringify(data, null, 2);
            const lines = jsonString.split('\n');

            // If it's a large object, show a collapsed view
            if (lines.length > 10) {
                const previewLines = lines.slice(0, 3);
                previewLines.push('  ...', '}');

                const collapsedDiv = document.createElement('div');
                collapsedDiv.innerHTML = `
                    <div style="color: #666; cursor: pointer; padding: 2px 0;" onclick="toggleJsonExpansion(this)">
                        ▶️ Show full metadata (${Object.keys(data).length} fields)
                    </div>
                    <pre style="margin: 0; color: #888;">${previewLines.join('\n')}</pre>
                `;

                const expandedDiv = document.createElement('div');
                expandedDiv.style.display = 'none';
                expandedDiv.innerHTML = `
                    <div style="color: #666; cursor: pointer; padding: 2px 0;" onclick="toggleJsonExpansion(this)">
                        🔽 Hide metadata
                    </div>
                    <pre style="margin: 0;">${jsonString}</pre>
                `;

                jsonDiv.appendChild(collapsedDiv);
                jsonDiv.appendChild(expandedDiv);
            } else {
                // Small object, show directly
                jsonDiv.innerHTML = `<pre style="margin: 0;">${jsonString}</pre>`;
            }

            container.appendChild(jsonDiv);
        }

        function toggleJsonExpansion(element) {
            const parent = element.parentElement.parentElement;
            const collapsed = parent.children[0];
            const expanded = parent.children[1];

            if (collapsed.style.display === 'none') {
                collapsed.style.display = 'block';
                expanded.style.display = 'none';
            } else {
                collapsed.style.display = 'none';
                expanded.style.display = 'block';
            }
        }

        async function deleteDocument(docId) {
            if (!confirm(`Really delete document ${docId}? This cannot be undone!`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/indexes/${selectedIndex}/documents/${docId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    alert('Document deleted successfully! Jean-Claude strikes again.');
                    selectIndex(selectedIndex); // Reload documents
                } else {
                    alert('Failed to delete document: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting document: ' + error.message);
            }
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.style.display = show ? 'block' : 'none';
            }
        }

        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="error">Error: ${message}</div>`;
        }

        // Placeholder functions for new actions
        function searchSimilar(docId) {
            alert(`Search Similar: This will find documents similar to ${docId}\n\nComing soon! Jean-Claude is still building this...`);
        }

        async function inspectMetadata(namespace) {
            const currentIndex = document.getElementById('index-dropdown').value;
            if (!currentIndex) {
                alert('Please select an index first');
                return;
            }

            // Show loading indicator
            const container = document.getElementById('documents-container');
            container.innerHTML = `
                <div class="loading">
                    <h3>🔍 Analyzing Metadata Patterns...</h3>
                    <p>Profiling metadata in namespace "${namespace || 'default'}"</p>
                    <p>This may take a moment for large indexes...</p>
                </div>
            `;

            try {
                const response = await fetch(`http://localhost:3001/api/indexes/${currentIndex}/metadata-profile?namespace=${namespace || ''}&maxDocuments=100`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to analyze metadata');
                }

                displayMetadataProfile(result.data, namespace);
            } catch (error) {
                console.error('Metadata analysis failed:', error);
                container.innerHTML = `
                    <div class="error">
                        <h3>❌ Metadata Analysis Failed</h3>
                        <p>Error: ${error.message}</p>
                        <p>Jean-Claude is probably debugging this right now...</p>
                        <button onclick="loadIndexData()">← Back to Index</button>
                    </div>
                `;
            }
        }

        function displayMetadataProfile(profile, namespace, selectedSampleSize = null) {
            const container = document.getElementById('documents-container');

            // Update global current sample size
            if (selectedSampleSize !== null) {
                currentSampleSize = selectedSampleSize;
            } else {
                // Infer sample size from analyzed documents
                currentSampleSize = profile.analyzedDocuments;
            }

            const html = `
                <div class="metadata-profile">
                    <div class="profile-header">
                        <h2>🔍 Metadata Profile - ${profile.indexName}</h2>
                        <div class="profile-info">
                            <span><strong>Namespace:</strong> ${namespace || 'default'}</span>
                            <span><strong>Documents Analyzed:</strong> ${profile.analyzedDocuments}</span>
                            <span><strong>Unique Keys:</strong> ${profile.analysisMetrics.totalUniqueKeys}</span>
                            <span><strong>Keys/Doc:</strong> ${profile.analysisMetrics.minKeysPerDocument}-${profile.analysisMetrics.maxKeysPerDocument} (avg: ${profile.analysisMetrics.avgKeysPerDocument})</span>
                        </div>
                        <div class="profile-actions">
                            <button onclick="loadIndexData('${namespace}')" class="back-btn">← Back to Index</button>
                            <div class="sample-size-options">
                                <span>Sample Size: </span>
                                <button onclick="reanalyzeWithSize(100, '${namespace}')" class="size-btn ${(selectedSampleSize === 100) || (selectedSampleSize === null && profile.analyzedDocuments <= 100) ? 'active' : ''}">100 (Fast)</button>
                                <button onclick="reanalyzeWithSize(1000, '${namespace}')" class="size-btn ${(selectedSampleSize === 1000) || (selectedSampleSize === null && profile.analyzedDocuments > 100 && profile.analyzedDocuments <= 1000) ? 'active' : ''}">1,000 (Slower)</button>
                                <button onclick="reanalyzeWithSize(10000, '${namespace}')" class="size-btn ${(selectedSampleSize === 10000) || (selectedSampleSize === null && profile.analyzedDocuments > 1000) ? 'active' : ''}">10,000 (Slowest)</button>
                            </div>
                        </div>
                    </div>

                    <div class="keys-analysis">
                        <h3>📊 Metadata Keys Analysis</h3>
                        ${profile.keyProfiles.map(key => createKeyProfileHTML(key, profile.indexName, namespace)).join('')}
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function createKeyProfileHTML(keyProfile, indexName, namespace) {
            const typeColor = getTypeColor(keyProfile.dataTypeAnalysis.primaryType);
            const presenceWidth = Math.max(keyProfile.presence, 5); // Minimum 5% width for visibility

            return `
                <div class="key-profile">
                    <div class="key-header">
                        <div class="key-info">
                            <span class="key-name">${keyProfile.keyName}</span>
                            <span class="key-type" style="background: ${typeColor}">${keyProfile.dataTypeAnalysis.primaryType}</span>
                            ${keyProfile.dataTypeAnalysis.subType ? `<span class="key-subtype">${keyProfile.dataTypeAnalysis.subType}</span>` : ''}
                        </div>
                        <div class="key-stats">
                            <span class="presence-bar">
                                <span class="presence-fill" style="width: ${presenceWidth}%"></span>
                                <span class="presence-text">${keyProfile.presence.toFixed(1)}% presence</span>
                            </span>
                            <span class="unique-count">${keyProfile.uniqueValueCount} unique values</span>
                        </div>
                    </div>

                    <div class="key-details">
                        <div class="data-quality">
                            <span><strong>Completeness:</strong> ${keyProfile.dataTypeAnalysis.statistics.completeness.toFixed(1)}%</span>
                            <span><strong>Uniqueness:</strong> ${keyProfile.dataTypeAnalysis.statistics.uniqueness.toFixed(1)}%</span>
                        </div>

                        <div class="sample-values">
                            <strong>Sample Values:</strong>
                            <span class="values-preview">${keyProfile.sampleValues.slice(0, 3).map(v => {
                                const str = JSON.stringify(v);
                                return str.length > 250 ? str.substring(0, 250) + '...' : str;
                            }).join(', ')}</span>
                        </div>
                    </div>

                    <div class="key-actions">
                        <button onclick="showRandomSamples('${indexName}', '${keyProfile.keyName}', '${namespace}')" class="action-btn">
                            🎲 Random 10
                        </button>
                        <button onclick="showCommonValues('${indexName}', '${keyProfile.keyName}', '${namespace}')" class="action-btn">
                            📊 Most Common 10
                        </button>
                        <button onclick="showKeyStats('${indexName}', '${keyProfile.keyName}', '${namespace}')" class="action-btn">
                            📈 Detailed Stats
                        </button>
                    </div>
                </div>
            `;
        }

        function getTypeColor(primaryType) {
            const colors = {
                'structured': '#9c27b0',
                'semantic': '#2196f3',
                'numeric': '#4caf50',
                'boolean': '#ff9800',
                'business': '#e91e63',
                'text': '#607d8b',
                'empty': '#9e9e9e'
            };
            return colors[primaryType] || '#666';
        }

        async function reanalyzeWithSize(sampleSize, namespace) {
            const currentIndex = document.getElementById('index-dropdown').value;

            let warning = '';
            if (sampleSize >= 1000) {
                warning = sampleSize === 1000 ?
                    'This will analyze 1,000 documents and may take 10-30 seconds.' :
                    'This will analyze 10,000 documents and may take 1-2 minutes.';

                // Show modal instead of browser alert
                showPerformanceWarningModal(warning, sampleSize, namespace);
                return;
            }

            // For sample sizes under 1000, proceed directly
            proceedWithAnalysis(sampleSize, namespace);
        }

        async function showRandomSamples(indexName, keyName, namespace) {
            try {
                // Show loading overlay
                showLoadingOverlay(
                    `🎲 Fetching Random Samples`,
                    `Analyzing ${currentSampleSize.toLocaleString()} documents for key "${keyName}"...`
                );

                const response = await fetch(`http://localhost:3001/api/indexes/${indexName}/metadata/${keyName}/samples?namespace=${namespace || ''}&count=10&type=random&maxDocuments=${currentSampleSize}`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch samples');
                }

                hideLoadingOverlay();
                displaySampleValues(result.data, 'Random Samples');
            } catch (error) {
                hideLoadingOverlay();
                alert(`Failed to fetch random samples: ${error.message}`);
            }
        }

        async function showCommonValues(indexName, keyName, namespace) {
            try {
                // Show loading overlay
                showLoadingOverlay(
                    `📊 Fetching Most Common Values`,
                    `Analyzing ${currentSampleSize.toLocaleString()} documents for key "${keyName}"...`
                );

                const response = await fetch(`http://localhost:3001/api/indexes/${indexName}/metadata/${keyName}/samples?namespace=${namespace || ''}&count=10&type=common&maxDocuments=${currentSampleSize}`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch common values');
                }

                hideLoadingOverlay();
                displaySampleValues(result.data, 'Most Common Values');
            } catch (error) {
                hideLoadingOverlay();
                alert(`Failed to fetch common values: ${error.message}`);
            }
        }

        async function showKeyStats(indexName, keyName, namespace) {
            try {
                // Show loading overlay
                showLoadingOverlay(
                    `📈 Generating Detailed Statistics`,
                    `Computing comprehensive analysis for ${currentSampleSize.toLocaleString()} documents...`
                );

                const response = await fetch(`http://localhost:3001/api/indexes/${indexName}/metadata/${keyName}/stats?namespace=${namespace || ''}&maxDocuments=${currentSampleSize}`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch key stats');
                }

                hideLoadingOverlay();
                displayKeyStats(result.data);
            } catch (error) {
                hideLoadingOverlay();
                alert(`Failed to fetch key statistics: ${error.message}`);
            }
        }

        async function deleteDocumentsWithKey(indexName, keyName, namespace) {
            if (!confirm(`⚠️ WARNING: This will permanently delete ALL documents that contain the metadata key "${keyName}".\n\nThis action cannot be undone. Are you sure?`)) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:3001/api/indexes/${indexName}/metadata/${keyName}/documents?namespace=${namespace || ''}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to delete documents');
                }

                alert(`✅ Successfully deleted ${result.data.deletedCount} documents containing key "${keyName}"`);

                // Refresh the metadata profile
                inspectMetadata(namespace);
            } catch (error) {
                alert(`❌ Failed to delete documents: ${error.message}`);
            }
        }

        function displaySampleValues(data, title) {
            const modalContent = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>${title} - ${data.keyName}</h3>
                            <button onclick="closeModal()" class="close-btn">✕</button>
                        </div>
                        <div class="modal-body">
                            <p><strong>Type:</strong> ${data.type} | <strong>Total Found:</strong> ${data.totalFound} | <strong>Showing:</strong> ${data.returned}</p>
                            <div class="values-list">
                                ${data.values.map((item, index) => `
                                    <div class="value-item">
                                        <span class="value-index">${index + 1}.</span>
                                        <span class="value-content">${JSON.stringify(item.value || item, null, 2)}</span>
                                        ${item.count ? `<span class="value-count">(${item.count} times, ${item.percentage}%)</span>` : ''}
                                        ${item.documentId ? `<span class="doc-id">Doc: ${item.documentId}</span>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        function displayKeyStats(data) {
            const modalContent = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>📈 Detailed Statistics - ${data.keyName}</h3>
                            <button onclick="closeModal()" class="close-btn">✕</button>
                        </div>
                        <div class="modal-body">
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <strong>Total Documents:</strong> ${data.totalDocuments}
                                </div>
                                <div class="stat-item">
                                    <strong>Documents with Key:</strong> ${data.documentsWithKey}
                                </div>
                                <div class="stat-item">
                                    <strong>Presence:</strong> ${data.presence}%
                                </div>
                                <div class="stat-item">
                                    <strong>Unique Values:</strong> ${data.uniqueValues}
                                </div>
                            </div>

                            <div class="type-analysis">
                                <h4>Data Type Analysis</h4>
                                <div class="type-details">
                                    <span><strong>Primary Type:</strong> ${data.dataTypeAnalysis.primaryType}</span>
                                    ${data.dataTypeAnalysis.subType ? `<span><strong>Sub Type:</strong> ${data.dataTypeAnalysis.subType}</span>` : ''}
                                    <span><strong>Completeness:</strong> ${data.dataTypeAnalysis.statistics.completeness.toFixed(1)}%</span>
                                    <span><strong>Uniqueness:</strong> ${data.dataTypeAnalysis.statistics.uniqueness.toFixed(1)}%</span>
                                </div>
                            </div>

                            <div class="value-distribution">
                                <h4>Top Value Distribution</h4>
                                <div class="distribution-list">
                                    ${data.valueDistribution.slice(0, 10).map(item => `
                                        <div class="distribution-item">
                                            <span class="distribution-value">${JSON.stringify(item.value)}</span>
                                            <span class="distribution-count">${item.count} times (${item.percentage}%)</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        function showPerformanceWarningModal(warning, sampleSize, namespace) {
            const modalContent = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>⚠️ Performance Warning</h3>
                            <button onclick="closeModal()" class="close-btn">✕</button>
                        </div>
                        <div class="modal-body">
                            <p><strong>${warning}</strong></p>
                            <p>Jean-Claude recommends having a coffee ready while this runs...</p>
                            <div class="modal-actions">
                                <button onclick="closeModal()" class="modal-btn modal-btn-cancel">Cancel</button>
                                <button onclick="closeModal(); proceedWithAnalysis(${sampleSize}, '${namespace}')" class="modal-btn modal-btn-proceed">Proceed Anyway</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        async function proceedWithAnalysis(sampleSize, namespace) {
            const currentIndex = document.getElementById('index-dropdown').value;

            // Show loading with different message based on size
            const container = document.getElementById('documents-container');
            const loadingMessage = sampleSize >= 1000 ?
                `Analyzing ${sampleSize.toLocaleString()} documents - this may take a while...` :
                `Analyzing ${sampleSize.toLocaleString()} documents...`;

            container.innerHTML = `
                <div class="loading">
                    <h3>🔍 Deep Metadata Analysis</h3>
                    <p>${loadingMessage}</p>
                    <p>Jean-Claude is crunching the numbers...</p>
                </div>
            `;

            try {
                const response = await fetch(`http://localhost:3001/api/indexes/${currentIndex}/metadata-profile?namespace=${namespace || ''}&maxDocuments=${sampleSize}`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to analyze metadata');
                }

                displayMetadataProfile(result.data, namespace, sampleSize);
            } catch (error) {
                console.error('Metadata analysis failed:', error);
                container.innerHTML = `
                    <div class="error">
                        <h3>❌ Analysis Failed</h3>
                        <p>Error: ${error.message}</p>
                        <button onclick="inspectMetadata('${namespace}')">← Try Again</button>
                    </div>
                `;
            }
        }

        async function deduplicateNamespace(namespace) {
            if (!selectedIndex) {
                alert('Please select an index first');
                return;
            }

            try {
                showLoadingOverlay('🔍 Analyzing Duplicates', `Scanning ${namespace} namespace for duplicate documents...`);

                // Call the duplicate analysis API
                const response = await fetch(`${API_URL}/indexes/${selectedIndex}/duplicates/analyze?namespace=${namespace}&similarity=fuzzy&threshold=85&maxDocuments=1000&strategy=keep-first`);
                const result = await response.json();

                hideLoadingOverlay();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to analyze duplicates');
                }

                // Show results in a modal
                showDuplicateAnalysisModal(result.data, namespace);

            } catch (error) {
                hideLoadingOverlay();
                console.error('Duplicate analysis failed:', error);
                alert(`Error analyzing duplicates: ${error.message}`);
            }
        }

        function showDuplicateAnalysisModal(analysis, namespace) {
            const duplicateCount = analysis.duplicateGroups.length;
            const documentsToDelete = analysis.potentialSavings.documentsToDelete;
            const estimatedSavings = analysis.potentialSavings.estimatedStorageSaved;

            // Calculate document counts for each deletion type
            const exactGroups = analysis.duplicateGroups.filter(group => group.similarityScore === 100);
            const fuzzyGroups = analysis.duplicateGroups.filter(group => group.similarityScore < 100);
            const exactDocsToDelete = exactGroups.reduce((sum, group) => sum + (group.documents.length - 1), 0);
            const fuzzyDocsToDelete = fuzzyGroups.reduce((sum, group) => sum + (group.documents.length - 1), 0);

            const modalContent = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2>🧪 Duplicate Analysis Results</h2>
                            <span class="close" onclick="closeModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="summary-stats">
                                <div class="stat-item">
                                    <strong>Index:</strong> ${analysis.indexName}
                                </div>
                                <div class="stat-item">
                                    <strong>Namespace:</strong> ${analysis.namespace}
                                </div>
                                <div class="stat-item">
                                    <strong>Total Documents:</strong> ${analysis.totalDocuments.toLocaleString()}
                                </div>
                                <div class="stat-item">
                                    <strong>Duplicate Groups:</strong> ${duplicateCount}
                                </div>
                                <div class="stat-item">
                                    <strong>Documents to Delete:</strong> ${documentsToDelete}
                                </div>
                                <div class="stat-item">
                                    <strong>Estimated Storage Saved:</strong> ${estimatedSavings}
                                </div>
                                <div class="stat-item">
                                    <strong>Processing Time:</strong> ${analysis.processingTime}ms
                                </div>
                            </div>

                            ${duplicateCount > 0 ? `
                                <div class="analysis-metrics">
                                    <h3>📊 Analysis Metrics</h3>
                                    <div class="metrics-grid">
                                        <div class="metric">
                                            <strong>Exact Matches:</strong> ${analysis.analysisMetrics.exactMatches}
                                        </div>
                                        <div class="metric">
                                            <strong>Fuzzy Matches:</strong> ${analysis.analysisMetrics.fuzzyMatches}
                                        </div>
                                        <div class="metric">
                                            <strong>Unique Documents:</strong> ${analysis.analysisMetrics.uniqueDocuments}
                                        </div>
                                    </div>
                                </div>

                                <div class="duplicate-groups">
                                    <h3>🔍 Duplicate Groups Preview</h3>
                                    <div class="groups-container">
                                        ${analysis.duplicateGroups.slice(0, 5).map(group => `
                                            <div class="duplicate-group">
                                                <div class="group-header">
                                                    <strong>Group ${group.id}</strong> - Similarity: ${group.similarityScore.toFixed(1)}%
                                                </div>
                                                <div class="group-reason">${group.reason}</div>
                                                <div class="group-fields">Matching fields: ${group.matchingFields.join(', ')}</div>
                                                <div class="group-documents">
                                                    ${group.documents.slice(0, 3).map(doc => `
                                                        <div class="duplicate-doc">
                                                            <code>${doc.id}</code>
                                                            ${Object.keys(doc.metadata).length > 0 ?
                                                                `<div class="metadata-preview">${JSON.stringify(doc.metadata).substring(0, 100)}...</div>`
                                                                : ''}
                                                        </div>
                                                    `).join('')}
                                                    ${group.documents.length > 3 ? `<div class="more-docs">... and ${group.documents.length - 3} more</div>` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                        ${analysis.duplicateGroups.length > 5 ? `<div class="more-groups">... and ${analysis.duplicateGroups.length - 5} more duplicate groups</div>` : ''}
                                    </div>
                                </div>

                                <div class="modal-actions">
                                    <div class="deletion-options">
                                        <h4>🗑️ Deletion Options</h4>
                                        <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Choose which types of duplicates to remove:</p>

                                        <button class="btn btn-danger" onclick="proceedWithDeletion('${analysis.indexName}', '${namespace}', 'exact', ${JSON.stringify(analysis.duplicateGroups).replace(/"/g, '&quot;')})">
                                            🎯 Delete Exact Matches Only (${exactDocsToDelete} documents)
                                        </button>

                                        <button class="btn btn-danger" onclick="proceedWithDeletion('${analysis.indexName}', '${namespace}', 'fuzzy', ${JSON.stringify(analysis.duplicateGroups).replace(/"/g, '&quot;')})">
                                            🔍 Delete Fuzzy Matches Only (${fuzzyDocsToDelete} documents)
                                        </button>

                                        <button class="btn btn-danger" onclick="proceedWithDeletion('${analysis.indexName}', '${namespace}', 'all', ${JSON.stringify(analysis.duplicateGroups).replace(/"/g, '&quot;')})">
                                            ⚠️ Delete ALL Duplicates (${documentsToDelete} documents)
                                        </button>
                                    </div>

                                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                                </div>
                            ` : `
                                <div class="no-duplicates">
                                    <h3>✅ No Duplicates Found</h3>
                                    <p>Great! Your namespace appears to be clean with no duplicate documents detected.</p>
                                </div>
                                <div class="modal-actions">
                                    <button class="btn btn-primary" onclick="closeModal()">Close</button>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        async function proceedWithDeletion(indexName, namespace, deletionType, duplicateGroups) {
            // Filter groups based on deletion type
            let groupsToDelete = [];
            let actionDescription = '';

            if (deletionType === 'exact') {
                groupsToDelete = duplicateGroups.filter(group => group.similarityScore === 100);
                actionDescription = 'exact match duplicates';
            } else if (deletionType === 'fuzzy') {
                groupsToDelete = duplicateGroups.filter(group => group.similarityScore < 100);
                actionDescription = 'fuzzy match duplicates';
            } else if (deletionType === 'all') {
                groupsToDelete = duplicateGroups;
                actionDescription = 'ALL duplicate documents';
            }

            const documentsToDelete = groupsToDelete.reduce((sum, group) => sum + (group.documents.length - 1), 0);

            if (documentsToDelete === 0) {
                alert(`No ${actionDescription} found to delete.`);
                return;
            }

            // Show confirmation modal instead of browser confirm
            showDeletionConfirmationModal(
                indexName,
                namespace,
                deletionType,
                documentsToDelete,
                groupsToDelete,
                actionDescription
            );
        }

        function showDeletionConfirmationModal(indexName, namespace, deletionType, documentsToDelete, groupsToDelete, actionDescription) {
            const modalContent = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                            <h3 style="color: white;">⚠️ DANGER - Confirm Deletion</h3>
                            <button onclick="closeModal()" class="close-btn" style="color: white;">✕</button>
                        </div>
                        <div class="modal-body">
                            <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <h4 style="color: #856404; margin: 0 0 10px 0;">⚠️ This action cannot be undone!</h4>
                                <p style="margin: 8px 0; color: #856404;"><strong>You are about to delete:</strong></p>
                                <ul style="margin: 10px 0; color: #856404;">
                                    <li><strong>${documentsToDelete}</strong> ${actionDescription}</li>
                                    <li><strong>${groupsToDelete.length}</strong> duplicate groups affected</li>
                                    <li>From namespace: <strong>${namespace || 'default'}</strong></li>
                                </ul>
                                <p style="margin: 10px 0 0 0; color: #dc3545; font-weight: bold;">
                                    This will permanently remove these documents from your Pinecone index!
                                </p>
                            </div>
                            <div class="modal-actions">
                                <button onclick="closeModal()" class="modal-btn modal-btn-cancel">Cancel</button>
                                <button onclick="closeModal(); executeDeletion('${indexName}', '${namespace}', '${deletionType}', ${JSON.stringify(groupsToDelete).replace(/"/g, '&quot;')}, '${actionDescription}')" class="modal-btn" style="background: #dc3545; color: white;">
                                    Delete ${documentsToDelete} Documents
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        async function executeDeletion(indexName, namespace, deletionType, groupsToDelete, actionDescription) {
            try {
                showLoadingOverlay('🗑️ Deleting Duplicates', `Removing ${actionDescription}... This may take a moment.`);

                const response = await fetch(`${API_URL}/indexes/${indexName}/duplicates/delete?namespace=${namespace}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        duplicateGroups: groupsToDelete,
                        confirmDeletion: true,
                        deletionType: deletionType
                    })
                });

                const result = await response.json();
                hideLoadingOverlay();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to delete duplicates');
                }

                // Show success modal with details
                showDeletionSuccessModal(result.data);

                // Refresh the current view
                if (selectedIndex) {
                    await loadIndexData();
                }

            } catch (error) {
                hideLoadingOverlay();
                console.error('Duplicate deletion failed:', error);
                showErrorModal('Deletion Failed', `Error deleting duplicates: ${error.message}`);
            }
        }

        function showDeletionSuccessModal(data) {
            const modalContent = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #218838 100%);">
                            <h3 style="color: white;">✅ Deduplication Complete!</h3>
                            <button onclick="closeModal()" class="close-btn" style="color: white;">✕</button>
                        </div>
                        <div class="modal-body">
                            <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <h4 style="color: #155724; margin: 0 0 10px 0;">Successfully removed duplicates!</h4>
                                <ul style="margin: 10px 0; color: #155724;">
                                    <li><strong>${data.deletedDocuments || 0}</strong> documents deleted</li>
                                    <li><strong>${data.deletedGroups || 0}</strong> duplicate groups processed</li>
                                    ${data.errors && data.errors.length > 0 ?
                                        `<li style="color: #dc3545;"><strong>${data.errors.length}</strong> errors occurred</li>` :
                                        `<li>All deletions completed successfully</li>`
                                    }
                                </ul>
                            </div>
                            ${data.errors && data.errors.length > 0 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer; color: #dc3545; font-weight: bold;">View Errors</summary>
                                    <ul style="margin-top: 10px; color: #dc3545;">
                                        ${data.errors.map(err => `<li>${err}</li>`).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                            <div class="modal-actions" style="justify-content: center;">
                                <button onclick="closeModal()" class="modal-btn modal-btn-proceed">
                                    OK
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        function showErrorModal(title, message) {
            const modalContent = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                            <h3 style="color: white;">❌ ${title}</h3>
                            <button onclick="closeModal()" class="close-btn" style="color: white;">✕</button>
                        </div>
                        <div class="modal-body">
                            <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 6px;">
                                <p style="margin: 0; color: #721c24;">${message}</p>
                            </div>
                            <div class="modal-actions" style="justify-content: center; margin-top: 20px;">
                                <button onclick="closeModal()" class="modal-btn modal-btn-cancel">
                                    OK
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        function searchNamespace(namespace) {
            alert(`Search Namespace: Advanced search within namespace "${namespace}"\n\nSupports metadata filters, text search, and vector similarity.\n\nComing soon!`);
        }

        // Loading overlay functions
        function showLoadingOverlay(title, subtitle) {
            const loadingHtml = `
                <div class="loading-overlay" id="loading-overlay">
                    <div class="loading-content">
                        <div class="spinner"></div>
                        <div class="loading-text">${title}</div>
                        <div class="loading-subtext">${subtitle}</div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', loadingHtml);

            // Disable all action buttons to prevent double-clicks
            const actionButtons = document.querySelectorAll('.action-btn');
            actionButtons.forEach(btn => btn.disabled = true);
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.remove();
            }

            // Re-enable all action buttons
            const actionButtons = document.querySelectorAll('.action-btn');
            actionButtons.forEach(btn => btn.disabled = false);
        }

        // Back to Index function - loads the main index view
        function loadIndexData(namespace = '') {
            const currentIndex = document.getElementById('index-dropdown').value;
            if (currentIndex) {
                selectIndex(currentIndex);
                // If a namespace was provided, load documents from that namespace
                if (namespace) {
                    loadDocumentsFromNamespace(currentIndex, namespace);
                }
            } else {
                // If no index selected, just clear the container and show the selection
                document.getElementById('documents-container').innerHTML = '';
                document.getElementById('documents-section').style.display = 'block';
            }
        }
    </script>
</body>
</html>